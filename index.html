<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ± IoT Smart Garden Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-bottom: 20px; text-align:center; padding:20px;}
.sensor-value { font-size: 2rem; font-weight: bold; margin-top:10px; }
.gradient-card { background: linear-gradient(135deg,#6dd5ed,#2193b0); color:#fff; }
.gradient-card2 { background: linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
.gradient-card3 { background: linear-gradient(135deg,#43e97b,#38f9d7); color:#fff; }
</style>
</head>
<body>
<div class="container py-4">
<h1 class="fw-bold text-center mb-4">ğŸŒ± IoT Smart Garden Dashboard</h1>

<!-- SENSOR DATA -->
<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card gradient-card"><div>ğŸŒ¿ Äá»™ áº©m Ä‘áº¥t</div><div class="sensor-value" id="soil">- %</div></div></div>
  <div class="col-md-4"><div class="card gradient-card2"><div>ğŸŒ¤ Nhiá»‡t Ä‘á»™</div><div class="sensor-value" id="temp">- Â°C</div></div></div>
  <div class="col-md-4"><div class="card gradient-card3"><div>ğŸ’§ Äá»™ áº©m KK</div><div class="sensor-value" id="hum">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>ğŸš¿ DÃ²ng cháº£y</div><div class="sensor-value" id="flow">-</div></div></div>
</div>

<!-- CONTROL PANEL -->
<div class="row g-3 mt-3">
  <div class="col-md-3">
    <div class="card p-3 text-center">
      <div>ğŸ’¡ Cháº¿ Ä‘á»™</div>
      <select class="form-select mt-2" id="modeSelect">
        <option value="AUTO">AUTO</option>
        <option value="MANUAL">MANUAL</option>
        <option value="SCHEDULE">SCHEDULE</option>
        <option value="SLEEP">SLEEP</option>
      </select>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 text-center">
      <div>ğŸš° BÆ¡m</div>
      <div class="sensor-value" id="pump">-</div>
      <button class="btn btn-success mt-2" id="pumpBtn">Báº­t/Táº¯t</button>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 text-center">
      <div>âš¡ CÃ´ng suáº¥t bÆ¡m (%)</div>
      <input type="range" class="form-range" min="0" max="100" step="1" id="pumpPower">
      <span id="pumpPowerLabel">36%</span>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 text-center">
      <button class="btn btn-primary w-100" id="saveBtn">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
    </div>
  </div>
</div>

<!-- SCHEDULE -->
<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Lá»‹ch tÆ°á»›i</h5>
      <div id="scheduleList" class="mb-2"></div>
      <div class="input-group mb-2">
        <input type="time" id="scheduleTime" class="form-control">
        <button class="btn btn-primary" id="addScheduleBtn">ThÃªm lá»‹ch</button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
const API_BASE = "https://iot-server-yc6r.onrender.com";
let pumpState = false;
let schedules = [];

// ================= FETCH DATA =================
async function fetchData(){
  try{
    const [sensorRes,statusRes] = await Promise.all([
      fetch(API_BASE+'/api/data'),
      fetch(API_BASE+'/api/status')
    ]);
    const sensor = await sensorRes.json();
    const status = await statusRes.json();

    document.getElementById('soil').textContent = sensor.soil ?? '- %';
    document.getElementById('temp').textContent = sensor.temp ?? '- Â°C';
    document.getElementById('hum').textContent = sensor.hum ?? '- %';
    document.getElementById('flow').textContent = sensor.flow ?? '-';
    document.getElementById('modeSelect').value = status.mode ?? 'AUTO';
    pumpState = status.pump ?? false;
    document.getElementById('pump').textContent = pumpState?'Báº¬T':'Táº®T';
    document.getElementById('pumpPower').value = status.pump_power ?? 36;
    document.getElementById('pumpPowerLabel').textContent = (status.pump_power ?? 36)+'%';
    schedules = status.schedules ?? [];
    updateScheduleUI();
  }catch(e){ console.error(e);}
}

// ================= SCHEDULE =================
function updateScheduleUI(){
  const list = document.getElementById('scheduleList');
  list.innerHTML='';
  schedules.forEach((t,i)=>{
    const div=document.createElement('div');
    div.className='d-flex justify-content-between align-items-center mb-1';
    div.innerHTML=`<span>${t.hour.toString().padStart(2,'0')}:${t.minute.toString().padStart(2,'0')}</span>
                   <button class="btn btn-sm btn-danger" onclick="removeSchedule(${i})">X</button>`;
    list.appendChild(div);
  });
}

async function addSchedule(){
  const val=document.getElementById('scheduleTime').value;
  if(!val) return;
  const [hour,minute]=val.split(':').map(Number);
  schedules.push({hour,minute});
  updateScheduleUI();
  document.getElementById('scheduleTime').value='';
}

function removeSchedule(i){
  schedules.splice(i,1);
  updateScheduleUI();
}

// ================= CONTROL =================
async function saveControl(){
  const mode=document.getElementById('modeSelect').value;
  const pump=pumpState;
  const pump_power=parseInt(document.getElementById('pumpPower').value);
  await fetch(API_BASE+'/api/control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode,pump,pump_power,schedules})
  });
  fetchData();
}

// ================= EVENT =================
document.getElementById('pumpBtn').addEventListener('click',()=>{
  pumpState=!pumpState;
  document.getElementById('pump').textContent = pumpState?'Báº¬T':'Táº®T';
});
document.getElementById('pumpPower').addEventListener('input',()=>{
  document.getElementById('pumpPowerLabel').textContent = document.getElementById('pumpPower').value+'%';
});
document.getElementById('saveBtn').addEventListener('click',saveControl);
document.getElementById('addScheduleBtn').addEventListener('click',addSchedule);

fetchData();
setInterval(fetchData,2000);
</script>
</body>
</html>
