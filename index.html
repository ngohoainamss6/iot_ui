<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå± IoT Smart Garden</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-bottom: 20px; text-align:center; padding:20px;}
.sensor-value { font-size: 2rem; font-weight: bold; margin-top:10px; }
.gradient-card { background: linear-gradient(135deg,#6dd5ed,#2193b0); color:#fff; }
.gradient-card2 { background: linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
.gradient-card3 { background: linear-gradient(135deg,#43e97b,#38f9d7); color:#fff; }
</style>
</head>
<body> 
<div class="container py-4">
<h1 class="fw-bold text-center mb-4">üå± IoT Smart Garden Dashboard</h1>

<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card gradient-card"><div>üåø ƒê·ªô ·∫©m ƒë·∫•t</div><div class="sensor-value" id="soil">- %</div></div></div>
  <div class="col-md-4"><div class="card gradient-card2"><div>üå§ Nhi·ªát ƒë·ªô</div><div class="sensor-value" id="temp">- ¬∞C</div></div></div>
  <div class="col-md-4"><div class="card gradient-card3"><div>üíß ƒê·ªô ·∫©m KK</div><div class="sensor-value" id="hum">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>Ch·∫ø ƒë·ªô hi·ªán t·∫°i</div><div class="sensor-value" id="currentMode">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>B∆°m hi·ªán t·∫°i</div><div class="sensor-value" id="pumpStatusText">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>üìâ Min Threshold</div><div class="sensor-value" id="min_val">- %</div></div></div>
  <div class="col-md-3"><div class="card"><div>üìà Max Threshold</div><div class="sensor-value" id="max_val">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>üöø D√≤ng ch·∫£y</div><div class="sensor-value" id="flow">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>‚è±Ô∏è Th·ªùi gian t∆∞·ªõi ti·∫øp theo</div><div class="sensor-value" id="next_time">- ph√∫t</div></div></div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>üí° Ch·ªçn ch·∫ø ƒë·ªô</div>
      <select id="modeSelect" class="form-select mt-2">
        <option value="AUTO">AUTO</option>
        <option value="MANUAL">MANUAL</option>
        <option value="SCHEDULE">SCHEDULE</option>
        <option value="SLEEP">SLEEP</option>
      </select>
      <button class="btn btn-primary mt-2" id="modeApply">G·ª≠i l·ªánh</button>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>üö∞ B·∫≠t/T·∫Øt b∆°m</div>
      <div class="form-check form-switch d-flex justify-content-center mt-3">
        <input class="form-check-input" type="checkbox" id="pumpSwitch" style="transform: scale(1.8); cursor:pointer;">
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>‚ö° C√¥ng su·∫•t b∆°m (%)</div>
      <input type="range" class="form-range" min="0" max="100" step="1" id="pumpPower">
      <span id="pumpPowerLabel">36%</span>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>L·ªãch t∆∞·ªõi</h5>
      <div id="scheduleList" class="mb-2"></div>
      <div class="input-group mb-2">
        <input type="time" id="scheduleTime" class="form-control">
        <button class="btn btn-primary" id="addScheduleBtn">Th√™m l·ªãch</button>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>L·ªánh ch·ªù ESP th·ª±c hi·ªán</h5>
      <div id="commandList">-</div>
    </div>
  </div>
</div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>üìú L·ªãch s·ª≠ ƒëi·ªÅu khi·ªÉn</h5>
      <table class="table table-striped table-bordered text-center align-middle" id="historyTable">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Ch·∫ø ƒë·ªô</th>
            <th>B∆°m</th>
            <th>C√¥ng su·∫•t</th>
            <th>L·ªãch t∆∞·ªõi</th>
            <th>Th·ªùi gian</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="5">ƒêang t·∫£i...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<script>
const API_BASE = "https://iot-server-yc6r.onrender.com";

// =============== SWITCH B∆†M ===============
const pumpSwitch = document.getElementById('pumpSwitch');
const pumpStatusText = document.getElementById('pumpStatusText');

pumpSwitch.addEventListener('change', async () => {
  const newState = pumpSwitch.checked;
  pumpStatusText.textContent = newState ? "ƒêang b·∫≠t..." : "ƒêang t·∫Øt...";
  try {
    const res = await fetch(`${API_BASE}/api/control`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pump: newState })
    });
    const data = await res.json();
    if (data.status === 'success') {
      pumpStatusText.textContent = newState ? "B·∫¨T" : "T·∫ÆT";
    } else {
      throw new Error('Server error');
    }
  } catch (err) {
    console.error(err);
    // Ch·ªâ rollback n·∫øu th·∫≠t s·ª± l·ªói
    pumpSwitch.checked = !newState;
    pumpStatusText.textContent = "‚ùå L·ªói m·∫°ng ho·∫∑c server";
  }
});


function updatePumpUI(pump){
  pumpSwitch.checked = !!pump;
  pumpStatusText.textContent = pump ? "B·∫¨T" : "T·∫ÆT";
}

// =============== FETCH D·ªÆ LI·ªÜU ===============
async function fetchData() {
  try {
    const sensorRes = await fetch(`${API_BASE}/api/data`);
    const sensor = await sensorRes.json();
    const statusRes = await fetch(`${API_BASE}/api/status`);
    const status = await statusRes.json();

    document.getElementById('soil').textContent = sensor.soil ?? '- %';
    document.getElementById('temp').textContent = sensor.temp ?? '- ¬∞C';
    document.getElementById('hum').textContent = sensor.hum ?? '- %';
    document.getElementById('flow').textContent = sensor.flow ?? '-';

    document.getElementById('currentMode').textContent = status.mode ?? '-';
    document.getElementById('min_val').textContent = status.min_val ?? '- %';
    document.getElementById('max_val').textContent = status.max_val ?? '- %';
    document.getElementById('next_time').textContent = status.next_time ?? '- ph√∫t';
    document.getElementById('pumpPower').value = status.pump_power ?? 36;
    document.getElementById('pumpPowerLabel').textContent = (status.pump_power ?? 36)+'%';
 
    updateScheduleUI(Array.isArray(status.schedules) ? status.schedules : []);

    const cmdRes = await fetch(`${API_BASE}/api/command`);
    const cmdStr = await cmdRes.text();
    document.getElementById('commandList').textContent = cmdStr || '-';
  } catch(err){ console.error(err); }
}

// =============== MODE ===============
document.getElementById('modeApply').addEventListener('click', async ()=>{
  const mode = document.getElementById('modeSelect').value;
  await fetch(`${API_BASE}/api/control`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode })
  });
});

// =============== C√îNG SU·∫§T ===============
const pumpPowerInput = document.getElementById('pumpPower');
pumpPowerInput.addEventListener('input', ()=> {
  document.getElementById('pumpPowerLabel').textContent = pumpPowerInput.value+'%';
});
pumpPowerInput.addEventListener('change', async ()=>{
  await fetch(`${API_BASE}/api/control`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ pump_power: parseInt(pumpPowerInput.value) })
  });
});

// =============== L·ªäCH T∆Ø·ªöI ===============
function updateScheduleUI(schedules){
  const list = document.getElementById('scheduleList');
  list.innerHTML = '';
  schedules.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='d-flex justify-content-between align-items-center mb-1';
    div.innerHTML = `<span>${t.hour.toString().padStart(2,'0')}:${t.minute.toString().padStart(2,'0')}</span>
                     <button class="btn btn-sm btn-danger" onclick="removeSchedule(${i})">X</button>`;
    list.appendChild(div);
  });
}
document.getElementById('addScheduleBtn').addEventListener('click', async ()=>{
  const val = document.getElementById('scheduleTime').value;
  if(!val) return;
  const [hour,minute] = val.split(':').map(Number);
  await fetch(`${API_BASE}/api/control`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({add_schedule:{hour,minute}})
  });
  document.getElementById('scheduleTime').value='';
});
async function removeSchedule(index){
  await fetch(`${API_BASE}/api/control`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({remove_schedule:index})
  });
}

// =============== L·ªäCH S·ª¨ ƒêI·ªÄU KHI·ªÇN ===============
async function fetchHistory() {
  try {
    const res = await fetch(`${API_BASE}/api/history`);
    const history = await res.json();
    const body = document.getElementById('historyBody');
    body.innerHTML = '';

    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
    if (!Array.isArray(history) || history.length === 0) {
      body.innerHTML = '<tr><td colspan="5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
      return;
    }

    // Duy·ªát qua t·ª´ng b·∫£n ghi l·ªãch s·ª≠
    history.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.id}</td>
        <td>${item.mode ?? '-'}</td>
        <td>
          <span class="badge ${item.pump ? 'bg-success' : 'bg-danger'}">
            ${item.pump ? 'B·∫¨T' : 'T·∫ÆT'}
          </span>
        </td>
        <td>${item.pump_power ?? '-'}%</td>
        <td>
          ${
            Array.isArray(item.schedules) && item.schedules.length > 0
              ? item.schedules
                  .map(t =>
                    `${t.hour.toString().padStart(2, '0')}:${t.minute
                      .toString()
                      .padStart(2, '0')}`
                  )
                  .join(', ')
              : '-'
          }
        </td>

        <td>${new Date(item.created_at).toLocaleString('vi-VN')}</td>
      `;
      body.appendChild(row);
    });
  } catch (err) {
    console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err);
    document.getElementById('historyBody').innerHTML =
      '<tr><td colspan="5" class="text-danger">‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
  }
}

// =============== AUTO REFRESH ===============
async function refreshAll() {
  await fetchData();
  await fetchHistory();
}

// C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 3 gi√¢y
setInterval(refreshAll, 3000);

// T·∫£i l·∫ßn ƒë·∫ßu
refreshAll();
</script>
</body>
</html>
