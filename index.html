<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå± H·ªá th·ªëng t∆∞·ªõi t·ª± ƒë·ªông</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
  body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
  .card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-bottom: 20px; }
  .card-header { font-weight: bold; font-size: 1.1rem; }
  .sensor-value { font-size: 2rem; font-weight: bold; }
  .status-led { width:15px; height:15px; border-radius:50%; display:inline-block; margin-right:10px; }
  .gradient-card { background: linear-gradient(135deg,#6dd5ed,#2193b0); color:#fff; }
  .gradient-card2 { background: linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
  .gradient-card3 { background: linear-gradient(135deg,#43e97b,#38f9d7); color:#fff; }
  .btn-group .btn { min-width:80px; }
</style>
</head>
<body>
<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="fw-bold">üåø Dashboard H·ªá th·ªëng t∆∞·ªõi t·ª± ƒë·ªông</h1>
    <p class="text-muted">Gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn tr·ª±c ti·∫øp t·ª´ browser</p>
  </div>

  <!-- SENSOR DATA -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card gradient-card text-center p-3">
        <div class="card-header"><i class="bi bi-droplet-half"></i> ƒê·ªô ·∫©m ƒë·∫•t</div>
        <div class="card-body">
          <div class="sensor-value" id="soil">0%</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card gradient-card2 text-center p-3">
        <div class="card-header"><i class="bi bi-thermometer-half"></i> Nhi·ªát ƒë·ªô</div>
        <div class="card-body">
          <div class="sensor-value" id="temp">0¬∞C</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card gradient-card3 text-center p-3">
        <div class="card-header"><i class="bi bi-cloud-sun"></i> ƒê·ªô ·∫©m KK</div>
        <div class="card-body">
          <div class="sensor-value" id="hum">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SYSTEM STATUS -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-speedometer2"></i> D√≤ng ch·∫£y</div>
        <div class="card-body">
          <div class="sensor-value" id="flow">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-arrow-down-circle"></i> Min Threshold</div>
        <div class="card-body">
          <div class="sensor-value" id="min">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-arrow-up-circle"></i> Max Threshold</div>
        <div class="card-body">
          <div class="sensor-value" id="max">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-clock"></i> Th·ªùi gian t∆∞·ªõi ti·∫øp theo</div>
        <div class="card-body">
          <div class="sensor-value" id="next">- ph√∫t</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTROL -->
  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-lightning-fill"></i> B∆°m n∆∞·ªõc <span class="status-led" id="pumpLed"></span></div>
        <div class="card-body">
          <div class="btn-group">
            <button class="btn btn-success" onclick="controlPump(true)">ON</button>
            <button class="btn btn-danger" onclick="controlPump(false)">OFF</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center p-3">
        <div class="card-header"><i class="bi bi-gear-fill"></i> Ch·∫ø ƒë·ªô</div>
        <div class="card-body">
          <select id="modeSelect" class="form-select" onchange="controlMode(this.value)">
            <option value="AUTO">AUTO</option>
            <option value="MANUAL">MANUAL</option>
            <option value="SCHEDULE">SCHEDULE</option>
            <option value="SLEEP">SLEEP</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function fetchStatus(){
  try{
    const res = await fetch('/api/status');
    const data = await res.json();
    document.getElementById('min').innerText = data.min_val;
    document.getElementById('max').innerText = data.max_val;
    document.getElementById('next').innerText = data.next_time+' ph√∫t';
    document.getElementById('modeSelect').value = data.mode;
    document.getElementById('flow').innerText = data.pump ? '1' : '0';
    document.getElementById('pumpLed').style.background = data.pump ? 'green' : 'red';
  }catch(e){console.error(e);}
}

async function fetchSensor(){
  try{
    const res = await fetch('/api/data');
    const d = await res.json();
    document.getElementById('soil').innerText = d.soil+'%';
    document.getElementById('temp').innerText = d.temp+'¬∞C';
    document.getElementById('hum').innerText = d.hum+'%';
  }catch(e){console.error(e);}
}

async function controlPump(state){
  await fetch('/api/control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pump:state, mode:document.getElementById('modeSelect').value})
  });
}

async function controlMode(mode){
  await fetch('/api/control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pump:document.getElementById('flow').innerText=='1', mode:mode})
  });
}

// refresh 1s
setInterval(fetchSensor,1000);
setInterval(fetchStatus,1000);
</script>
</body>
</html>
