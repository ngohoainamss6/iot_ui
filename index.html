<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ± IoT Smart Garden</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-bottom: 20px; text-align:center; padding:20px;}
.sensor-value { font-size: 2rem; font-weight: bold; margin-top:10px; }
.gradient-card { background: linear-gradient(135deg,#6dd5ed,#2193b0); color:#fff; }
.gradient-card2 { background: linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
.gradient-card3 { background: linear-gradient(135deg,#43e97b,#38f9d7); color:#fff; }
</style>
</head>
<body>
<div class="container py-4">
<h1 class="fw-bold text-center mb-4">ğŸŒ± IoT Smart Garden Dashboard</h1>

<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card gradient-card"><div>ğŸŒ¿ Äá»™ áº©m Ä‘áº¥t</div><div class="sensor-value" id="soil">- %</div></div></div>
  <div class="col-md-4"><div class="card gradient-card2"><div>ğŸŒ¤ Nhiá»‡t Ä‘á»™</div><div class="sensor-value" id="temp">- Â°C</div></div></div>
  <div class="col-md-4"><div class="card gradient-card3"><div>ğŸ’§ Äá»™ áº©m KK</div><div class="sensor-value" id="hum">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>Cháº¿ Ä‘á»™ hiá»‡n táº¡i</div><div class="sensor-value" id="currentMode">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>BÆ¡m hiá»‡n táº¡i</div><div class="sensor-value" id="pumpStatusText">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>ğŸ“‰ Min Threshold</div><div class="sensor-value" id="min_val">- %</div></div></div>
  <div class="col-md-3"><div class="card"><div>ğŸ“ˆ Max Threshold</div><div class="sensor-value" id="max_val">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>ğŸš¿ DÃ²ng cháº£y</div><div class="sensor-value" id="flow">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>â±ï¸ Thá»i gian tÆ°á»›i tiáº¿p theo</div><div class="sensor-value" id="next_time">- phÃºt</div></div></div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>ğŸ’¡ Chá»n cháº¿ Ä‘á»™</div>
      <select id="modeSelect" class="form-select mt-2">
        <option value="AUTO">AUTO</option>
        <option value="MANUAL">MANUAL</option>
        <option value="SCHEDULE">SCHEDULE</option>
        <option value="SLEEP">SLEEP</option>
      </select>
      <button class="btn btn-primary mt-2" id="modeApply">Gá»­i lá»‡nh</button>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>ğŸš° Báº­t/Táº¯t bÆ¡m</div>
      <div class="form-check form-switch d-flex justify-content-center mt-3">
        <input class="form-check-input" type="checkbox" id="pumpSwitch" style="transform: scale(1.8); cursor:pointer;">
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>âš¡ CÃ´ng suáº¥t bÆ¡m (%)</div>
      <input type="range" class="form-range" min="0" max="100" step="1" id="pumpPower">
      <span id="pumpPowerLabel">36%</span>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Lá»‹ch tÆ°á»›i</h5>
      <div id="scheduleList" class="mb-2"></div>
      <div class="input-group mb-2">
        <input type="time" id="scheduleTime" class="form-control">
        <button class="btn btn-primary" id="addScheduleBtn">ThÃªm lá»‹ch</button>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Lá»‡nh chá» ESP thá»±c hiá»‡n</h5>
      <div id="commandList">-</div>
    </div>
  </div>
</div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>ğŸ“œ Lá»‹ch sá»­ Ä‘iá»u khiá»ƒn</h5>
      <table class="table table-striped table-bordered text-center align-middle" id="historyTable">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Cháº¿ Ä‘á»™</th>
            <th>BÆ¡m</th>
            <th>CÃ´ng suáº¥t</th>
            <th>Thá»i gian</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="5">Äang táº£i...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<script>
const API_BASE = "https://iot-server-yc6r.onrender.com";

// =============== SWITCH BÆ M ===============
const pumpSwitch = document.getElementById('pumpSwitch');
const pumpStatusText = document.getElementById('pumpStatusText');

pumpSwitch.addEventListener('change', async () => {
  const newState = pumpSwitch.checked;
  pumpStatusText.textContent = newState ? "Äang báº­t..." : "Äang táº¯t...";
  try {
    const res = await fetch(`${API_BASE}/api/control`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pump: newState })
    });
    const data = await res.json();
    if (data.status === 'success') {
      pumpStatusText.textContent = newState ? "Báº¬T" : "Táº®T";
    } else {
      throw new Error('Server error');
    }
  } catch (err) {
    console.error(err);
    // Chá»‰ rollback náº¿u tháº­t sá»± lá»—i
    pumpSwitch.checked = !newState;
    pumpStatusText.textContent = "âŒ Lá»—i máº¡ng hoáº·c server";
  }
});


function updatePumpUI(pump){
  pumpSwitch.checked = !!pump;
  pumpStatusText.textContent = pump ? "Báº¬T" : "Táº®T";
}

// =============== FETCH Dá»® LIá»†U ===============
async function fetchData() {
  try {
    const sensorRes = await fetch(`${API_BASE}/api/data`);
    const sensor = await sensorRes.json();
    const statusRes = await fetch(`${API_BASE}/api/status`);
    const status = await statusRes.json();

    document.getElementById('soil').textContent = sensor.soil ?? '- %';
    document.getElementById('temp').textContent = sensor.temp ?? '- Â°C';
    document.getElementById('hum').textContent = sensor.hum ?? '- %';
    document.getElementById('flow').textContent = sensor.flow ?? '-';

    document.getElementById('currentMode').textContent = status.mode ?? '-';
    document.getElementById('min_val').textContent = status.min_val ?? '- %';
    document.getElementById('max_val').textContent = status.max_val ?? '- %';
    document.getElementById('next_time').textContent = status.next_time ?? '- phÃºt';
    document.getElementById('pumpPower').value = status.pump_power ?? 36;
    document.getElementById('pumpPowerLabel').textContent = (status.pump_power ?? 36)+'%';
 
    updateScheduleUI(Array.isArray(status.schedules) ? status.schedules : []);

    const cmdRes = await fetch(`${API_BASE}/api/command`);
    const cmdStr = await cmdRes.text();
    document.getElementById('commandList').textContent = cmdStr || '-';
  } catch(err){ console.error(err); }
}

// =============== MODE ===============
document.getElementById('modeApply').addEventListener('click', async ()=>{
  const mode = document.getElementById('modeSelect').value;
  await fetch(`${API_BASE}/api/control`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode })
  });
});

// =============== CÃ”NG SUáº¤T ===============
const pumpPowerInput = document.getElementById('pumpPower');
pumpPowerInput.addEventListener('input', ()=> {
  document.getElementById('pumpPowerLabel').textContent = pumpPowerInput.value+'%';
});
pumpPowerInput.addEventListener('change', async ()=>{
  await fetch(`${API_BASE}/api/control`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ pump_power: parseInt(pumpPowerInput.value) })
  });
});

// =============== Lá»ŠCH TÆ¯á»šI ===============
function updateScheduleUI(schedules){
  const list = document.getElementById('scheduleList');
  list.innerHTML = '';
  schedules.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='d-flex justify-content-between align-items-center mb-1';
    div.innerHTML = `<span>${t.hour.toString().padStart(2,'0')}:${t.minute.toString().padStart(2,'0')}</span>
                     <button class="btn btn-sm btn-danger" onclick="removeSchedule(${i})">X</button>`;
    list.appendChild(div);
  });
}
document.getElementById('addScheduleBtn').addEventListener('click', async ()=>{
  const val = document.getElementById('scheduleTime').value;
  if(!val) return;
  const [hour,minute] = val.split(':').map(Number);
  await fetch(`${API_BASE}/api/control`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({add_schedule:{hour,minute}})
  });
  document.getElementById('scheduleTime').value='';
});
async function removeSchedule(index){
  await fetch(`${API_BASE}/api/control`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({remove_schedule:index})
  });
}

// =============== Lá»ŠCH Sá»¬ ÄIá»€U KHIá»‚N ===============
async function fetchHistory() {
  try {
    const res = await fetch(`${API_BASE}/api/history`);
    const history = await res.json();
    const body = document.getElementById('historyBody');
    body.innerHTML = '';

    // Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u
    if (!Array.isArray(history) || history.length === 0) {
      body.innerHTML = '<tr><td colspan="5">ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>';
      return;
    }

    // Duyá»‡t qua tá»«ng báº£n ghi lá»‹ch sá»­
    history.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.id}</td>
        <td>${item.mode ?? '-'}</td>
        <td>
          <span class="badge ${item.pump ? 'bg-success' : 'bg-danger'}">
            ${item.pump ? 'Báº¬T' : 'Táº®T'}
          </span>
        </td>
        <td>${item.pump_power ?? '-'}%</td>
        <td>${new Date(item.created_at).toLocaleString('vi-VN')}</td>
      `;
      body.appendChild(row);
    });
  } catch (err) {
    console.error("Lá»—i táº£i lá»‹ch sá»­:", err);
    document.getElementById('historyBody').innerHTML =
      '<tr><td colspan="5" class="text-danger">âŒ Lá»—i khi táº£i dá»¯ liá»‡u</td></tr>';
  }
}

// =============== AUTO REFRESH ===============
async function refreshAll() {
  await fetchData();
  await fetchHistory();
}

// Cáº­p nháº­t dá»¯ liá»‡u má»—i 3 giÃ¢y
setInterval(refreshAll, 3000);

// Táº£i láº§n Ä‘áº§u
refreshAll();
</script>
</body>
</html>
