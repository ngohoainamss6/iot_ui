<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ± IoT Smart Garden Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
.card { border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-bottom: 20px; text-align:center; padding:20px;}
.sensor-value { font-size: 2rem; font-weight: bold; margin-top:10px; }
.gradient-card { background: linear-gradient(135deg,#6dd5ed,#2193b0); color:#fff; }
.gradient-card2 { background: linear-gradient(135deg,#f093fb,#f5576c); color:#fff; }
.gradient-card3 { background: linear-gradient(135deg,#43e97b,#38f9d7); color:#fff; }
</style>
</head>
<body>
<div class="container py-4">
<h1 class="fw-bold text-center mb-4">ğŸŒ± IoT Smart Garden Dashboard</h1>

<!-- Dá»¯ liá»‡u cáº£m biáº¿n -->
<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card gradient-card"><div>ğŸŒ¿ Äá»™ áº©m Ä‘áº¥t</div><div class="sensor-value" id="soil">- %</div></div></div>
  <div class="col-md-4"><div class="card gradient-card2"><div>ğŸŒ¤ Nhiá»‡t Ä‘á»™</div><div class="sensor-value" id="temp">- Â°C</div></div></div>
  <div class="col-md-4"><div class="card gradient-card3"><div>ğŸ’§ Äá»™ áº©m KK</div><div class="sensor-value" id="hum">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>Cháº¿ Ä‘á»™ hiá»‡n táº¡i</div><div class="sensor-value" id="currentMode">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>BÆ¡m hiá»‡n táº¡i</div><div class="sensor-value" id="pumpStatusText">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>ğŸ“‰ Min Threshold</div><div class="sensor-value" id="min_val">- %</div></div></div>
  <div class="col-md-3"><div class="card"><div>ğŸ“ˆ Max Threshold</div><div class="sensor-value" id="max_val">- %</div></div></div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card"><div>ğŸš¿ DÃ²ng cháº£y</div><div class="sensor-value" id="flow">-</div></div></div>
  <div class="col-md-3"><div class="card"><div>â±ï¸ Thá»i gian tÆ°á»›i tiáº¿p theo</div><div class="sensor-value" id="next_time">- phÃºt</div></div></div>
</div>

<!-- Äiá»u khiá»ƒn -->
<div class="row g-3 mt-3">
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>ğŸ’¡ Chá»n cháº¿ Ä‘á»™</div>
      <select id="modeSelect" class="form-select mt-2">
        <option value="AUTO">AUTO</option>
        <option value="MANUAL">MANUAL</option>
        <option value="SCHEDULE">SCHEDULE</option>
        <option value="SLEEP">SLEEP</option>
      </select>
      <button class="btn btn-primary mt-2" id="modeApply">Gá»­i lá»‡nh</button>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>ğŸš° Báº­t/Táº¯t bÆ¡m</div>
      <div class="form-check form-switch d-flex justify-content-center mt-3">
        <input class="form-check-input" type="checkbox" id="pumpSwitch" style="transform: scale(1.8); cursor:pointer;">
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div>âš¡ CÃ´ng suáº¥t bÆ¡m (%)</div>
      <input type="range" class="form-range" min="0" max="100" step="1" id="pumpPower">
      <span id="pumpPowerLabel">36%</span>
    </div>
  </div>
</div>

<!-- Lá»‹ch tÆ°á»›i -->
<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Lá»‹ch tÆ°á»›i</h5>
      <div id="scheduleList" class="mb-2"></div>
      <div class="input-group mb-2">
        <input type="time" id="scheduleTime" class="form-control">
        <button class="btn btn-primary" id="addScheduleBtn">ThÃªm lá»‹ch</button>
      </div>
    </div>
  </div>
</div>

<!-- Lá»‡nh chá» ESP -->
<div class="row g-3 mt-3">
  <div class="col-md-12">
    <div class="card p-3">
      <h5>Lá»‡nh chá» ESP thá»±c hiá»‡n</h5>
      <div id="commandList">-</div>
    </div>
  </div>
</div>

</div>

<script>
const API_BASE = "https://iot-server-yc6r.onrender.com";

// ======== HÃ m update UI ========
function updatePumpUI(pump){
  pumpSwitch.checked = !!pump;
  pumpStatusText.textContent = pump ? "Báº¬T" : "Táº®T";
}
function updateScheduleUI(schedules){
  const list = document.getElementById('scheduleList');
  list.innerHTML = '';
  schedules.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='d-flex justify-content-between align-items-center mb-1';
    div.innerHTML = `<span>${t.hour.toString().padStart(2,'0')}:${t.minute.toString().padStart(2,'0')}</span>
                     <button class="btn btn-sm btn-danger" onclick="removeSchedule(${i})">X</button>`;
    list.appendChild(div);
  });
}

// ======== FETCH STATUS ========
async function fetchStatus(){
  try{
    const res = await fetch(`${API_BASE}/api/status`);
    const status = await res.json();
    document.getElementById('soil').textContent = status.soil ?? '- %';
    document.getElementById('temp').textContent = status.temp ?? '- Â°C';
    document.getElementById('hum').textContent = status.hum ?? '- %';
    document.getElementById('flow').textContent = status.flow ?? '-';
    document.getElementById('currentMode').textContent = status.mode ?? '-';
    document.getElementById('min_val').textContent = status.min_val ?? '- %';
    document.getElementById('max_val').textContent = status.max_val ?? '- %';
    document.getElementById('next_time').textContent = status.next_time ?? '- phÃºt';
    document.getElementById('pumpPower').value = status.pump_power ?? 36;
    document.getElementById('pumpPowerLabel').textContent = (status.pump_power ?? 36)+'%';
    updatePumpUI(status.pump);
    updateScheduleUI(Array.isArray(status.schedules)?status.schedules:[]);
  }catch(e){ console.error(e); }
}

// ======== MODE ========
document.getElementById('modeApply').addEventListener('click', async ()=>{
  const mode = document.getElementById('modeSelect').value;
  await fetch(`${API_BASE}/api/mode`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ mode })
  });
});

// ======== PUMP ========
pumpSwitch.addEventListener('change', async ()=>{
  if(document.getElementById('currentMode').textContent!=='MANUAL'){
    alert("Chá»‰ cháº¿ Ä‘á»™ MANUAL má»›i báº­t/táº¯t bÆ¡m");
    fetchStatus();
    return;
  }
  const newState = pumpSwitch.checked;
  pumpStatusText.textContent = newState ? "Äang báº­t..." : "Äang táº¯t...";
  try{
    const res = await fetch(`${API_BASE}/api/pump`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ pump: newState })
    });
    const data = await res.json();
    if(data.status==='success') updatePumpUI(newState);
    else throw new Error('Server error');
  }catch(e){ console.error(e); fetchStatus(); }
});

// ======== PUMP POWER ========
const pumpPowerInput = document.getElementById('pumpPower');
pumpPowerInput.addEventListener('input',()=>{ document.getElementById('pumpPowerLabel').textContent = pumpPowerInput.value+'%'; });
pumpPowerInput.addEventListener('change', async ()=>{
  await fetch(`${API_BASE}/api/pump_power`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ pump_power: parseInt(pumpPowerInput.value) })
  });
});

// ======== SCHEDULE ========
document.getElementById('addScheduleBtn').addEventListener('click', async ()=>{
  const val = document.getElementById('scheduleTime').value;
  if(!val) return;
  const [hour,minute] = val.split(':').map(Number);
  await fetch(`${API_BASE}/api/schedule`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ add_schedule:{hour,minute} })
  });
  document.getElementById('scheduleTime').value='';
});
async function removeSchedule(index){
  await fetch(`${API_BASE}/api/schedule`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ remove_schedule:index })
  });
}

// ======== COMMAND LIST ========
async function fetchCommand(){
  try{
    const res = await fetch(`${API_BASE}/api/command`);
    const str = await res.text();
    document.getElementById('commandList').textContent = str||'-';
  }catch(e){ console.error(e); }
}

// ======== AUTO REFRESH ========
setInterval(()=>{ fetchStatus(); fetchCommand(); }, 2000);
fetchStatus();
fetchCommand();

</script>
</body>
</html>
