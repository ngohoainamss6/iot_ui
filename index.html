<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå± H·ªá th·ªëng t∆∞·ªõi t·ª± ƒë·ªông</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .card { margin-bottom:15px; }
  .status-led { width:15px; height:15px; border-radius:50%; display:inline-block; margin-right:5px; }
</style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h2 class="text-center mb-4">üåø H·ªá th·ªëng t∆∞·ªõi t·ª± ƒë·ªông</h2>
  <div class="row">
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-header">ƒê·ªô ·∫©m ƒë·∫•t</div>
        <div class="card-body">
          <h3 id="soil">0%</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-header">Nhi·ªát ƒë·ªô</div>
        <div class="card-body">
          <h3 id="temp">0¬∞C</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-header">ƒê·ªô ·∫©m KK</div>
        <div class="card-body">
          <h3 id="hum">0%</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3"><div class="card text-center"><div class="card-header">D√≤ng ch·∫£y</div><div class="card-body"><h3 id="flow">0</h3></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-header">Min Threshold</div><div class="card-body"><h3 id="min">-</h3></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-header">Max Threshold</div><div class="card-body"><h3 id="max">-</h3></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-header">Th·ªùi gian t∆∞·ªõi ti·∫øp theo</div><div class="card-body"><h3 id="next">- ph√∫t</h3></div></div></div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card text-center">
        <div class="card-header">B∆°m n∆∞·ªõc</div>
        <div class="card-body">
          <button class="btn btn-success me-2" onclick="controlPump(true)">ON</button>
          <button class="btn btn-danger" onclick="controlPump(false)">OFF</button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center">
        <div class="card-header">Ch·∫ø ƒë·ªô</div>
        <div class="card-body">
          <select id="modeSelect" class="form-select" onchange="controlMode(this.value)">
            <option value="AUTO">AUTO</option>
            <option value="MANUAL">MANUAL</option>
            <option value="SCHEDULE">SCHEDULE</option>
            <option value="SLEEP">SLEEP</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function fetchStatus(){
  try{
    const res = await fetch('/api/status');
    const data = await res.json();
    document.getElementById('min').innerText = data.min_val;
    document.getElementById('max').innerText = data.max_val;
    document.getElementById('next').innerText = data.next_time+' ph√∫t';
    document.getElementById('modeSelect').value = data.mode;
    document.getElementById('flow').innerText = data.pump ? '1' : '0';
  }catch(e){console.error(e);}
}

async function fetchSensor(){
  try{
    const res = await fetch('/api/data');
    const d = await res.json();
    document.getElementById('soil').innerText = d.soil+'%';
    document.getElementById('temp').innerText = d.temp+'¬∞C';
    document.getElementById('hum').innerText = d.hum+'%';
  }catch(e){console.error(e);}
}

async function controlPump(state){
  await fetch('/api/control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pump:state, mode:document.getElementById('modeSelect').value})
  });
}

async function controlMode(mode){
  await fetch('/api/control',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pump:document.getElementById('flow').innerText=='1', mode:mode})
  });
}

// refresh m·ªói 2s
setInterval(fetchSensor,2000);
setInterval(fetchStatus,2000);
</script>
</body>
</html>
